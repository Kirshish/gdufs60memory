<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åˆ†äº«ä½ çš„è®°å¿† - è®°å¿†äº¤æ¢è®¡åˆ’</title>
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@3.15.0/dist/av-min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        position: relative;
    }
    
    .container {
      max-width: 600px;
      width: 100%;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideUp 0.5s ease-out;
      margin: 20px auto;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .header h1 {
      color: #667eea;
      font-size: 32px;
      margin-bottom: 10px;
    }
    
    .header p {
      color: #666;
      font-size: 16px;
    }
    
    .form-group {
      margin-bottom: 30px;
    }
    
    label {
      display: block;
      margin-bottom: 10px;
      color: #333;
      font-weight: 600;
      font-size: 16px;
    }
    
    .required {
      color: #e74c3c;
      margin-left: 3px;
    }
    
    .optional {
      color: #999;
      font-weight: 400;
      font-size: 14px;
      margin-left: 5px;
    }
    
    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s;
      font-family: inherit;
    }
    
    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    textarea {
      min-height: 150px;
      resize: vertical;
      line-height: 1.6;
    }
    
    .char-count {
      text-align: right;
      font-size: 14px;
      color: #999;
      margin-top: 5px;
    }
    
    .char-count.warning {
      color: #e74c3c;
    }
    
    .radio-group,
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 10px;
    }
    
    .radio-item,
    .checkbox-item {
      flex: 0 0 calc(50% - 7.5px);
      display: flex;
      align-items: center;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .radio-item:hover,
    .checkbox-item:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }
    
    .radio-item input,
    .checkbox-item input {
      margin-right: 8px;
      cursor: pointer;
    }
    
    .radio-item.selected,
    .checkbox-item.selected {
      border-color: #667eea;
      background: #f8f9ff;
    }
    
    /* å›¾ç‰‡ä¸Šä¼ æ ·å¼ */
    .upload-area {
      border: 2px dashed #e0e0e0;
      border-radius: 10px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #fafafa;
    }
    
    .upload-area:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }
    
    .upload-area.dragover {
      border-color: #667eea;
      background: #f0f3ff;
    }
    
    .upload-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    .upload-text {
      color: #666;
      font-size: 16px;
      margin-bottom: 5px;
    }
    
    .upload-hint {
      color: #999;
      font-size: 14px;
    }
    
    #photoInput {
      display: none;
    }
    
    .preview-container {
      margin-top: 20px;
      display: none;
    }
    
    .preview-container.show {
      display: block;
    }
    
    .preview-image {
      width: 100%;
      max-height: 300px;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    
    .preview-actions {
      display: flex;
      gap: 10px;
    }
    
    .btn-secondary {
      flex: 1;
      padding: 10px;
      background: #f0f0f0;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .btn-secondary:hover {
      background: #e0e0e0;
    }
    
    .upload-progress {
      margin-top: 15px;
      display: none;
    }
    
    .upload-progress.show {
      display: block;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s;
    }
    
    .progress-text {
      text-align: center;
      font-size: 14px;
      color: #666;
    }
    
    .hint {
      font-size: 14px;
      color: #666;
      margin-top: 8px;
      line-height: 1.5;
    }
    
    .hidden {
      display: none;
    }
    
    .submit-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }
    
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }
    
    .submit-btn:active {
      transform: translateY(0);
    }
    
    .submit-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .error-message {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }
    
    .error-message.show {
      display: block;
      animation: shake 0.5s;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    
    @media (max-width: 600px) {
      .container {
        padding: 25px;
      }
      
      .header h1 {
        font-size: 26px;
      }
      
      .radio-item,
      .checkbox-item {
        flex: 0 0 100%;
      }
    }
        /* ========== ç§»åŠ¨ç«¯ä¼˜åŒ– ========== */

    /* é˜²æ­¢ç‚¹å‡»é«˜äº® */
    * {
      -webkit-tap-highlight-color: transparent;
    }

    /* ç¡®ä¿é¡µé¢å¯ä»¥æ»šåŠ¨ */
    html, body {
      width: 100%;
      overflow-x: hidden;
    }

    body {
      align-items: flex-start;
      padding-top: 20px;
    }

    /* ç§»åŠ¨ç«¯å“åº”å¼ */
    @media (max-width: 600px) {
      body {
        padding: 15px;
        padding-top: 20px;
        padding-bottom: 30px;
      }
      
      .container {
        padding: 25px 20px;
        margin: 0 auto;
      }
      
      h1 {
        font-size: 24px;
      }
      
      .subtitle {
        font-size: 13px;
      }
      
      input, textarea, select {
        font-size: 16px !important; /* é˜²æ­¢ iOS è‡ªåŠ¨ç¼©æ”¾ */
        padding: 12px;
      }
      
      textarea {
        min-height: 100px;
      }
      
      button {
        padding: 14px;
        font-size: 17px;
      }
      
      .form-group {
        margin-bottom: 18px;
      }
    }

    /* é”®ç›˜å¼¹å‡ºæ—¶çš„ä¼˜åŒ– */
    @media (max-height: 600px) {
      body {
        padding-top: 10px;
        padding-bottom: 10px;
      }
      
      .container {
        margin-top: 0;
      }
      
      h1 {
        font-size: 22px;
        margin-bottom: 8px;
      }
      
      .subtitle {
        margin-bottom: 15px;
      }
      
      .form-group {
        margin-bottom: 12px;
      }
    }

    /* æŒ‰é’®è§¦æ„Ÿåé¦ˆ */
    button:active {
      transform: scale(0.98);
      opacity: 0.9;
    }

    /* é˜²æ­¢åŒå‡»ç¼©æ”¾ */
    input, textarea, button, select {
      touch-action: manipulation;
    }

  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“® åˆ†äº«ä½ çš„è®°å¿†</h1>
      <p>è®©æ—¶å…‰åœ¨è¿™é‡Œäº¤æ±‡</p>
    </div>
    
    <div class="error-message" id="errorMessage"></div>
    
    <form id="memoryForm">
      <!-- èº«ä»½ -->
      <div class="form-group">
        <label>ä½ çš„èº«ä»½ <span class="required">*</span></label>
        <div class="radio-group">
          <label class="radio-item">
            <input type="radio" name="identity" value="åœ¨æ ¡ç”Ÿ" required>
            <span>ğŸ“ åœ¨æ ¡ç”Ÿ</span>
          </label>
          <label class="radio-item">
            <input type="radio" name="identity" value="æ ¡å‹">
            <span>ğŸ–ï¸ æ ¡å‹</span>
          </label>
        </div>
      </div>
      
      <!-- å±Šåˆ«/å¹´çº§ -->
      <div class="form-group">
        <label>å¹´çº§/å±Šåˆ« <span class="required">*</span></label>
        <select name="grade" id="gradeSelect" required>
          <option value="">è¯·å…ˆé€‰æ‹©èº«ä»½</option>
        </select>
      </div>
      
      <!-- è®°å¿†å†…å®¹ -->
      <div class="form-group">
        <label>ä½ æƒ³åˆ†äº«çš„è®°å¿† <span class="required">*</span></label>
        <textarea name="content" id="contentInput" required placeholder="å¯ä»¥æ˜¯ä¸€æ®µéš¾å¿˜çš„ç»å†ã€ä¸€å¥æƒ³è¯´çš„è¯ã€ä¸€ä¸ªå°æ•…äº‹...&#10;&#10;ä¾‹å¦‚ï¼š&#10;â€¢ å›¾ä¹¦é¦†ä¸‰æ¥¼é çª—çš„ä½ç½®ï¼Œé™ªæˆ‘åº¦è¿‡äº†æ— æ•°ä¸ªå¤‡è€ƒçš„å¤œæ™š&#10;â€¢ é£Ÿå ‚é˜¿å§¨çš„ä¸€å¥â€œå¤šåƒç‚¹â€ ï¼Œæ˜¯æœ€æ¸©æš–çš„å…³æ€€&#10;â€¢ æ¯•ä¸šé‚£å¤©ï¼Œæˆ‘ä»¬åœ¨æ“åœºä¸Šå“­æˆäº†æ³ªäºº"></textarea>
        <div class="char-count" id="charCount">0/200</div>
      </div>
      
      <!-- è®°å¿†æ ‡ç­¾ -->
      <div class="form-group">
        <label>è®°å¿†æ ‡ç­¾ <span class="required">*</span> <span style="font-size: 14px; color: #999;">(å¯å¤šé€‰)</span></label>
        <div class="checkbox-group">
          <label class="checkbox-item">
            <input type="checkbox" name="tags" value="è¯¾å ‚æ—¶å…‰">
            <span>ğŸ“š è¯¾å ‚æ—¶å…‰</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="tags" value="ç¤¾å›¢æ´»åŠ¨">
            <span>ğŸ­ ç¤¾å›¢æ´»åŠ¨</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="tags" value="å›¾ä¹¦é¦†">
            <span>ğŸ“– å›¾ä¹¦é¦†</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="tags" value="é£Ÿå ‚ç¾é£Ÿ">
            <span>ğŸœ é£Ÿå ‚ç¾é£Ÿ</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="tags" value="å®¿èˆè¶£äº‹">
            <span>ğŸ  å®¿èˆè¶£äº‹</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="tags" value="æ‹çˆ±å›å¿†">
            <span>ğŸ’• æ‹çˆ±å›å¿†</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="tags" value="è€ƒè¯•å‘¨">
            <span>ğŸ“ è€ƒè¯•å‘¨</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="tags" value="æ¯•ä¸šå­£">
            <span>ğŸ“ æ¯•ä¸šå­£</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="tags" value="èŒä¸šå‘å±•">
            <span>ğŸ’¼ èŒä¸šå‘å±•</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="tags" value="å…¶ä»–">
            <span>âœ¨ å…¶ä»–</span>
          </label>
        </div>
      </div>
      
      <!-- ç…§ç‰‡ä¸Šä¼  -->
      <div class="form-group">
        <label>æœ‰ç…§ç‰‡å—ï¼Ÿ<span class="optional">(å¯é€‰)</span></label>
        <div class="hint" style="margin-bottom: 15px;">
          ä¸Šä¼ ä¸€å¼ æœ€èƒ½ä»£è¡¨è¿™æ®µè®°å¿†çš„ç…§ç‰‡ å¯ä»¥æ˜¯é£æ™¯ã€åˆå½±ã€æˆªå›¾... ä»»ä½•ä½ æƒ³åˆ†äº«çš„ï¼ˆä¼šå‡ºç°åœ¨ä½ çš„ä¸“å±å¡ç‰‡ä¸Šï¼‰
        </div>
        
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon">ğŸ“·</div>
          <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ ç…§ç‰‡</div>
          <div class="upload-hint">æ”¯æŒ JPGã€PNGã€GIFï¼Œæœ€å¤§ 5MB</div>
        </div>
        
        <input type="file" id="photoInput" accept="image/*">
        
        <div class="upload-progress" id="uploadProgress">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="progress-text" id="progressText">ä¸Šä¼ ä¸­...</div>
        </div>
        
        <div class="preview-container" id="previewContainer">
          <img id="previewImage" class="preview-image" src="" alt="é¢„è§ˆ">
          <div class="preview-actions">
            <button type="button" class="btn-secondary" id="reuploadBtn">é‡æ–°ä¸Šä¼ </button>
            <button type="button" class="btn-secondary" id="deleteBtn">åˆ é™¤ç…§ç‰‡</button>
          </div>
        </div>
      </div>
      
      <!-- ç½²åæ–¹å¼ -->
      <div class="form-group">
        <label>ç½²åæ–¹å¼ <span class="required">*</span></label>
        <div class="radio-group">
          <label class="radio-item">
            <input type="radio" name="signatureType" value="åŒ¿å" required>
            <span>ğŸ­ åŒ¿å</span>
          </label>
          <label class="radio-item">
            <input type="radio" name="signatureType" value="æ˜¾ç¤ºå¹´çº§">
            <span>ğŸ“… æ˜¾ç¤ºå¹´çº§</span>
          </label>
          <label class="radio-item">
            <input type="radio" name="signatureType" value="æ˜¾ç¤ºæ˜µç§°">
            <span>âœ¨ æ˜¾ç¤ºæ˜µç§°</span>
          </label>
        </div>
        <div class="hint">
          â€¢ åŒ¿åï¼šä¸æ˜¾ç¤ºä»»ä½•ä¿¡æ¯<br>
          â€¢ æ˜¾ç¤ºå¹´çº§ï¼šå¦‚"2023çº§çš„TA"<br>
          â€¢ æ˜¾ç¤ºæ˜µç§°ï¼šæ˜¾ç¤ºä½ å¡«å†™çš„æ˜µç§°
        </div>
      </div>
      
      <!-- æ˜µç§° -->
      <div class="form-group hidden" id="nicknameGroup">
        <label>æ˜µç§°</label>
        <input type="text" name="nickname" id="nicknameInput" placeholder="2-8ä¸ªå­—" maxlength="8">
      </div>
      
      <button type="submit" class="submit-btn" id="submitBtn">ğŸš€ æŠ•é€’è®°å¿†</button>
    </form>
  </div>

  <script>
    // åˆå§‹åŒ–LeanCloud
    AV.init({
      appId: "AjDlSqRRtPZxgvP7oKE51Ed3-MdYXbMMI",
      appKey: "AmW2gLklfoggtMLACiWLkYZr",
      serverURL: "https://files.gdufs60memory.site"
    });
    
    // å…¨å±€å˜é‡
    let uploadedPhotoFile = null;  // å­˜å‚¨ä¸Šä¼ çš„LeanCloudæ–‡ä»¶å¯¹è±¡
    
    // åœ¨æ ¡ç”Ÿé€‰é¡¹
    const studentGrades = [
      '2025çº§ï¼ˆå¤§ä¸€/ç ”ä¸€ï¼‰',
      '2024çº§ï¼ˆå¤§äºŒ/ç ”äºŒï¼‰',
      '2023çº§ï¼ˆå¤§ä¸‰/ç ”ä¸‰ï¼‰',
      '2022çº§ï¼ˆå¤§å››/ç ”å››ï¼‰',
      '2021çº§ï¼ˆå¤§äº”/åšå£«ï¼‰',
      '2020çº§åŠä¹‹å‰'
    ];
    
    // æ ¡å‹é€‰é¡¹
    const alumniGrades = [
      '2025å±Šï¼ˆä»Šå¹´åˆšç¦»æ ¡ï¼‰',
      '2024å±Šï¼ˆæ¯•ä¸š1å¹´ï¼‰',
      '2023å±Šï¼ˆæ¯•ä¸š2å¹´ï¼‰',
      '2022å±Šï¼ˆæ¯•ä¸š3å¹´ï¼‰',
      '2021å±Šï¼ˆæ¯•ä¸š4å¹´ï¼‰',
      '2016-2020å±Šï¼ˆæ¯•ä¸š5-9å¹´ï¼‰',
      '2011-2015å±Šï¼ˆæ¯•ä¸š10-14å¹´ï¼‰',
      '2006-2010å±Šï¼ˆæ¯•ä¸š15-19å¹´ï¼‰',
      '2001-2005å±Šï¼ˆæ¯•ä¸š20-24å¹´ï¼‰',
      '1996-2000å±Šï¼ˆæ¯•ä¸š25-29å¹´ï¼‰',
      '1991-1995å±Šï¼ˆæ¯•ä¸š30-34å¹´ï¼‰',
      '1965-1990å±Šï¼ˆæ¯•ä¸š35å¹´ä»¥ä¸Šï¼‰'
    ];
    
    // ç›‘å¬èº«ä»½é€‰æ‹©
    document.querySelectorAll('input[name="identity"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const gradeSelect = document.getElementById('gradeSelect');
        gradeSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
        
        const grades = this.value === 'åœ¨æ ¡ç”Ÿ' ? studentGrades : alumniGrades;
        grades.forEach(grade => {
          const option = document.createElement('option');
          option.value = grade;
          option.textContent = grade;
          gradeSelect.appendChild(option);
        });
        
        // æ·»åŠ é€‰ä¸­æ ·å¼
        document.querySelectorAll('.radio-item').forEach(item => {
          item.classList.remove('selected');
        });
        this.closest('.radio-item').classList.add('selected');
      });
    });
    
    // ç›‘å¬æ ‡ç­¾é€‰æ‹©
    document.querySelectorAll('input[name="tags"]').forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        if (this.checked) {
          this.closest('.checkbox-item').classList.add('selected');
        } else {
          this.closest('.checkbox-item').classList.remove('selected');
        }
      });
    });
    
    // ç›‘å¬ç½²åæ–¹å¼é€‰æ‹©
    document.querySelectorAll('input[name="signatureType"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const nicknameGroup = document.getElementById('nicknameGroup');
        if (this.value === 'æ˜¾ç¤ºæ˜µç§°') {
          nicknameGroup.classList.remove('hidden');
        } else {
          nicknameGroup.classList.add('hidden');
        }
        
        // æ·»åŠ é€‰ä¸­æ ·å¼
        document.querySelectorAll('input[name="signatureType"]').forEach(r => {
          r.closest('.radio-item').classList.remove('selected');
        });
        this.closest('.radio-item').classList.add('selected');
      });
    });
    
    // å­—æ•°ç»Ÿè®¡
    const contentInput = document.getElementById('contentInput');
    const charCount = document.getElementById('charCount');
    
    contentInput.addEventListener('input', function() {
      const length = this.value.length;
      charCount.textContent = `${length}/200`;
      
      if (length > 200) {
        charCount.classList.add('warning');
      } else {
        charCount.classList.remove('warning');
      }
    });
    
    // ========== å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ ==========
    
    const uploadArea = document.getElementById('uploadArea');
    const photoInput = document.getElementById('photoInput');
    const previewContainer = document.getElementById('previewContainer');
    const previewImage = document.getElementById('previewImage');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const reuploadBtn = document.getElementById('reuploadBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    
    // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
    uploadArea.addEventListener('click', () => {
      photoInput.click();
    });
    
    // é€‰æ‹©æ–‡ä»¶
    photoInput.addEventListener('change', handleFileSelect);
    
    // æ‹–æ‹½ä¸Šä¼ 
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    });
    
    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (file) {
        handleFile(file);
      }
    }
    
    // å¤„ç†æ–‡ä»¶
    async function handleFile(file) {
      // éªŒè¯æ–‡ä»¶ç±»å‹
      if (!file.type.startsWith('image/')) {
        showError('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶');
        return;
      }
      
      // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆ5MBï¼‰
      if (file.size > 5 * 1024 * 1024) {
        showError('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MB');
        return;
      }
      
      // æ˜¾ç¤ºè¿›åº¦æ¡
      uploadProgress.classList.add('show');
      uploadArea.style.display = 'none';
      
      try {
        // ä¸Šä¼ åˆ°LeanCloud
        const avFile = new AV.File(file.name, file);
        
        // ç›‘å¬ä¸Šä¼ è¿›åº¦
        await avFile.save({
          onprogress: (progress) => {
            const percent = (progress.percent * 100).toFixed(0);
            progressFill.style.width = percent + '%';
            progressText.textContent = `ä¸Šä¼ ä¸­... ${percent}%`;
          }
        });
        
        // ä¸Šä¼ æˆåŠŸ
        uploadedPhotoFile = avFile;
        
        // æ˜¾ç¤ºé¢„è§ˆ
        previewImage.src = avFile.url();
        uploadProgress.classList.remove('show');
        previewContainer.classList.add('show');
        
        console.log('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', avFile.url());
        
      } catch (error) {
        console.error('ä¸Šä¼ å¤±è´¥:', error);
        showError('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼š' + error.message);
        
        // é‡ç½®UI
        uploadProgress.classList.remove('show');
        uploadArea.style.display = 'block';
      }
    }
    
    // é‡æ–°ä¸Šä¼ 
    reuploadBtn.addEventListener('click', () => {
      previewContainer.classList.remove('show');
      uploadArea.style.display = 'block';
      photoInput.value = '';
      uploadedPhotoFile = null;
    });
    
    // åˆ é™¤ç…§ç‰‡
    deleteBtn.addEventListener('click', () => {
      previewContainer.classList.remove('show');
      uploadArea.style.display = 'block';
      photoInput.value = '';
      uploadedPhotoFile = null;
    });
    
    // ========== è¡¨å•æäº¤ ==========
    
    document.getElementById('memoryForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'æäº¤ä¸­...';
      
      try {
        // è·å–è¡¨å•æ•°æ®
        const formData = new FormData(this);
        const identity = formData.get('identity');
        const grade = formData.get('grade');
        const content = formData.get('content');
        const tags = formData.getAll('tags');
        const signatureType = formData.get('signatureType');
        const nickname = formData.get('nickname');
        
        // éªŒè¯å¿…å¡«é¡¹
        if (!identity || !grade || !content || tags.length === 0 || !signatureType) {
          showError('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹');
          submitBtn.disabled = false;
          submitBtn.textContent = 'ğŸš€ æŠ•é€’è®°å¿†';
          return;
        }
        
        // éªŒè¯å†…å®¹é•¿åº¦
        if (content.length < 10) {
          showError('è®°å¿†å†…å®¹è‡³å°‘éœ€è¦10ä¸ªå­—');
          submitBtn.disabled = false;
          submitBtn.textContent = 'ğŸš€ æŠ•é€’è®°å¿†';
          return;
        }
        
        if (content.length > 200) {
          showError('è®°å¿†å†…å®¹ä¸èƒ½è¶…è¿‡200å­—');
          submitBtn.disabled = false;
          submitBtn.textContent = 'ğŸš€ æŠ•é€’è®°å¿†';
          return;
        }
        
        // éªŒè¯æ˜µç§°
        if (signatureType === 'æ˜¾ç¤ºæ˜µç§°') {
          if (!nickname || nickname.trim().length < 2) {
            showError('æ˜µç§°è‡³å°‘éœ€è¦2ä¸ªå­—');
            submitBtn.disabled = false;
            submitBtn.textContent = 'ğŸš€ æŠ•é€’è®°å¿†';
            return;
          }
        }
        
        // ä¿å­˜åˆ°LeanCloud
        const Memory = AV.Object.extend('Memory');
        const memory = new Memory();
        
        memory.set('identity', identity);
        memory.set('grade', grade);
        memory.set('content', content);
        memory.set('tags', tags);
        memory.set('signatureType', signatureType);
        memory.set('nickname', nickname || '');
        memory.set('isMatched', false);
        memory.set('matchCount', 0);
        
        // å¦‚æœæœ‰ç…§ç‰‡ï¼Œä¿å­˜ç…§ç‰‡URL
        if (uploadedPhotoFile) {
          memory.set('photo', uploadedPhotoFile.url());
          memory.set('photoFile', uploadedPhotoFile);  // ä¿å­˜æ–‡ä»¶å¯¹è±¡ï¼Œæ–¹ä¾¿åç»­æ“ä½œ
        }
        
        await memory.save();
        
        // æˆåŠŸæç¤º
        alert('âœ… æäº¤æˆåŠŸï¼å³å°†è·³è½¬åˆ°æç“¶é¡µé¢...');
        
        // è·³è½¬åˆ°æç“¶é¡µé¢
        window.location.href = 'receive.html?identity=' + encodeURIComponent(identity);
        
      } catch (error) {
        console.error('æäº¤å¤±è´¥:', error);
        showError('æäº¤å¤±è´¥ï¼š' + error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸš€ æŠ•é€’è®°å¿†';
      }
    });
    
    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    function showError(message) {
      const errorMessage = document.getElementById('errorMessage');
      errorMessage.textContent = message;
      errorMessage.classList.add('show');
      
      setTimeout(() => {
        errorMessage.classList.remove('show');
      }, 3000);
    }
     
    // é˜²æ­¢åŒå‡»ç¼©æ”¾
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
    
    // è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æ—¶æ»šåŠ¨åˆ°å¯è§ä½ç½®
    document.querySelectorAll('input, textarea').forEach(element => {
      element.addEventListener('focus', function() {
        setTimeout(() => {
          this.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      });
    });
  </script>
</body>
</html>
